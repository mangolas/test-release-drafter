name: Update current release candidate PR from dev

on:
  push:
    branches:
      - dev

jobs:
  update_release_draft:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - id: cache
        uses: actions/cache@v1
        with:
          path: /opt/bin
          key: opt-bin-hub-2.1.4
      - name: Install hub
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p /opt/bin
          curl -L https://github.com/github/hub/releases/download/v2.14.0/hub-linux-amd64-2.14.0.tgz -o /tmp/hub.tgz
          tar xzf /tmp/hub.tgz -C /tmp
          mv /tmp/hub-*/bin/hub /opt/bin/hub
      - name: Push changes to 'next-release-candidate' branch
        run: |
          git checkout -b next-release-candidate
          git fetch origin next-release-candidate || echo "No remote branch yet."
          git push --set-upstream origin next-release-candidate --force-with-lease
      - name: Create pull request if needed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::add-path::/opt/bin"
          pr_num=$(hub pr list -f '%I' -h next-release-candidate)
          if [[ -z $pr_num ]]; then
            echo "No existing pull request, creating new ..."
            hub pull-request \
              -b rc \
              -m "Next release candidate" \
              -m "This is automatically created pull request from pushes to dev." \
              -m "Merge this branch to trigger next release candidate deploy." \
              -l skip-changelog \
              -l release-candidate
          else
            echo "Pull request exists, nothing to do ..."
          fi
